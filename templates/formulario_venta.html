{% load static %}  <!DOCTYPE html><html lang="es">        
<head>
    <link rel="shortcut icon" type="image/png" href="{% static 'img/favicon.png' %}"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta | NextGen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Estilo para cuando la sucursal está bloqueada */
        .bloqueado { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-6">
        <div class="bg-indigo-600 rounded-xl shadow-lg p-4 mb-6 flex justify-between items-center text-white">
            <h1 class="text-2xl font-bold"><i class="fas fa-cash-register mr-2"></i> NextGen</h1>
             <div class="flex gap-3">
                <a href="/dashboard/" class="text-sm bg-indigo-500 hover:bg-indigo-700 py-1 px-3 rounded-full transition">
                    <i class="fas fa-chart-line"></i> Ir a Dashboard
                </a>
                <span class="text-sm bg-indigo-800 py-1 px-3 rounded-full">Ventas</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                <h2 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-2">1. Datos de Venta</h2>
                
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Sucursal *</label>
                    <select id="sucursal" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 bg-white">
                        <option value="">-- Seleccione --</option>
                        {% for s in sucursales %}
                            <option value="{{ s.id_sucursal }}">{{ s.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Cajero *</label>
                    <select id="empleado" class="w-full border p-2 rounded bg-gray-50">
                        {% for e in empleados %}
                            <option value="{{ e.id_empleado }}">{{ e.nombre }} {{ e.apellido }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-1">Cliente *</label>
                    <input type="text" id="cliente" placeholder="Nombre Completo" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500">
                </div>

                <h2 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-2">2. Agregar Producto</h2>

                <div class="mb-3">
                    <label class="block text-sm font-semibold mb-1">Buscar Producto</label>
                    <select id="producto" onchange="cargarInfoProducto()" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500">
                        <option value="">-- Seleccione un producto --</option>
                        {% for p in productos %}
                            <option value="{{ p.id_producto }}" 
                                    data-nombre="{{ p.nombre }}" 
                                    data-precio="{{ p.precio_unitario }}"
                                    data-marca="{{ p.id_marca.nombre_marca }}" 
                                    data-categoria="{{ p.id_categoria.nombre_categoria }}"
                                    data-stock="{{ p.stock }}">
                                {{ p.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <span class="text-xs text-gray-500 uppercase font-bold">Marca</span>
                        <input type="text" id="marca_info" readonly class="w-full bg-gray-100 border p-2 rounded text-sm text-gray-600">
                    </div>
                    <div>
                        <span class="text-xs text-gray-500 uppercase font-bold">Categoría</span>
                        <input type="text" id="cat_info" readonly class="w-full bg-gray-100 border p-2 rounded text-sm text-gray-600">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <span class="text-xs text-gray-500 uppercase font-bold">Precio Unit.</span>
                        <input type="text" id="precio_info" readonly class="w-full bg-gray-100 border p-2 rounded font-bold text-indigo-600">
                    </div>
                    <div>
                        <span class="text-xs text-gray-500 uppercase font-bold">Stock Actual</span>
                        <input type="text" id="stock_info" readonly class="w-full bg-gray-100 border p-2 rounded text-center font-mono">
                    </div>
                </div>

                <div class="flex gap-2 items-end">
                    <div class="w-1/3">
                        <label class="block text-sm font-bold mb-1">Cant.</label>
                        <input type="number" id="cantidad" value="1" min="1" max="1000" 
                               oninput="validarInput(this)"
                               class="w-full border-2 border-indigo-100 p-2 rounded text-center font-bold focus:outline-none focus:border-indigo-500">
                    </div>
                    <button onclick="agregarAlCarrito()" class="w-2/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow transition transform hover:scale-105">
                        <i class="fas fa-plus"></i> AGREGAR
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 flex flex-col h-full bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-700"><i class="fas fa-shopping-cart"></i> Resumen de Venta</h2>
                    <span id="contador-items" class="text-xs bg-gray-200 px-2 py-1 rounded">0 items</span>
                </div>

                <div class="flex-grow overflow-auto mb-4">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-800 text-white uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">Producto</th>
                                <th class="px-4 py-3">Detalle</th>
                                <th class="px-4 py-3 text-center">Cant</th>
                                <th class="px-4 py-3 text-right">Subtotal</th>
                                <th class="px-4 py-3 text-center rounded-tr-lg">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-4 py-10 text-center text-gray-400 italic">
                                    No hay productos agregados.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-auto border-t pt-4">
                    <div class="flex justify-end items-center text-2xl font-bold text-gray-800 mb-4">
                        <span class="text-lg font-normal text-gray-500 mr-4">Total a Pagar:</span>
                        <span id="total-pagar" class="text-indigo-600">$0.00</span>
                    </div>
                    <button onclick="procesarVenta()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition">
                        <i class="fas fa-check-circle mr-2"></i> FINALIZAR VENTA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let carrito = [];

        // VALIDACIÓN DE INPUT
        function validarInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            let valor = parseInt(input.value);
            if (isNaN(valor) || valor < 1) {
                input.value = 1;
            } else if (valor > 1000) {
                input.value = 1000;
            }
        }

        function cargarInfoProducto() {
            const select = document.getElementById('producto');
            const option = select.options[select.selectedIndex];

            if (!select.value) {
                document.getElementById('marca_info').value = "";
                document.getElementById('cat_info').value = "";
                document.getElementById('precio_info').value = "";
                document.getElementById('stock_info').value = "";
                return;
            }

            document.getElementById('marca_info').value = option.getAttribute('data-marca');
            document.getElementById('cat_info').value = option.getAttribute('data-categoria');
            
            let precio = parseFloat(option.getAttribute('data-precio'));
            document.getElementById('precio_info').value = "$" + precio.toFixed(2);
            document.getElementById('stock_info').value = option.getAttribute('data-stock');
        }

        function agregarAlCarrito() {
            const sucursalSelect = document.getElementById('sucursal');
            
            if (!sucursalSelect.value) {
                return Swal.fire('Atención', 'Seleccione una sucursal primero.', 'warning');
            }

            const productoSelect = document.getElementById('producto');
            const id = productoSelect.value;
            
            if (!id) return Swal.fire('Atención', 'Seleccione un producto.', 'warning');

            const option = productoSelect.options[productoSelect.selectedIndex];
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const stockMax = parseInt(option.getAttribute('data-stock'));
            const precio = parseFloat(option.getAttribute('data-precio'));

            let cantidadActualEnCarrito = 0;
            const existe = carrito.find(item => item.id_producto === id);
            if (existe) cantidadActualEnCarrito = existe.cantidad;

            if ((cantidad + cantidadActualEnCarrito) > stockMax) {
                return Swal.fire('Stock Insuficiente', `Solo hay ${stockMax} unidades disponibles.`, 'error');
            }

            if (existe) {
                existe.cantidad += cantidad;
                existe.subtotal = existe.cantidad * precio;
            } else {
                carrito.push({
                    id_producto: id,
                    nombre: option.getAttribute('data-nombre'),
                    marca: option.getAttribute('data-marca'),
                    categoria: option.getAttribute('data-categoria'),
                    precio: precio,
                    cantidad: cantidad,
                    subtotal: precio * cantidad
                });
            }

            document.getElementById('cantidad').value = 1;
            renderizarTabla();
        }

        function eliminarItem(index) {
            carrito.splice(index, 1);
            renderizarTabla();
        }

        function renderizarTabla() {
            const tbody = document.getElementById('tabla-body');
            const sucursalSelect = document.getElementById('sucursal');
            
            tbody.innerHTML = '';
            let total = 0;
            let items = 0;

            if (carrito.length > 0) {
                sucursalSelect.classList.add('bloqueado');
                sucursalSelect.setAttribute('disabled', 'disabled');
            } else {
                sucursalSelect.classList.remove('bloqueado');
                sucursalSelect.removeAttribute('disabled');
            }

            if (carrito.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-10 text-center text-gray-400 italic">No hay productos agregados.</td></tr>';
            }

            carrito.forEach((item, index) => {
                total += item.subtotal;
                items += item.cantidad;
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-3 font-medium">${item.nombre}</td>
                        <td class="px-4 py-3 text-xs text-gray-500">${item.marca} - ${item.categoria}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="bg-indigo-100 text-indigo-800 py-1 px-2 rounded font-bold">${item.cantidad}</span>
                        </td>
                        <td class="px-4 py-3 text-right font-mono">$${item.subtotal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="eliminarItem(${index})" class="text-red-500 hover:text-red-700 hover:bg-red-100 p-2 rounded-full transition">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('total-pagar').innerText = "$" + total.toFixed(2);
            document.getElementById('contador-items').innerText = items + " items";
        }

        function procesarVenta() {
            if (carrito.length === 0) return Swal.fire('Carrito Vacío', 'Agrega productos antes de finalizar.', 'warning');
            
            const cliente = document.getElementById('cliente').value;
            if (!cliente.trim()) return Swal.fire('Falta Cliente', 'Escribe el nombre del cliente.', 'warning');

            Swal.fire({
                title: '¿Confirmar Venta?',
                text: "Se registrará la venta y descontará el stock.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                confirmButtonText: 'Sí, Finalizar'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarDatosAlServidor();
                }
            });
        }

        function enviarDatosAlServidor() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const data = {
                id_sucursal: document.getElementById('sucursal').value,
                id_empleado: document.getElementById('empleado').value,
                cliente: document.getElementById('cliente').value,
                items: carrito
            };

            fetch('/nueva-venta/', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Error desconocido en servidor'); });
                }
                return response.json();
            })
            .then(data => {
                // AQUÍ ES EL CAMBIO CLAVE: Usamos data.codigo
                Swal.fire(
                    '¡Venta Exitosa!', 
                    `Ticket Generado: <b>${data.codigo}</b>`, 
                    'success'
                ).then(() => {
                    location.reload(); 
                });
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', error.message, 'error');
            });
        }
    </script>
</body>
</html>